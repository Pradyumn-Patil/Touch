<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Touch Frame Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-video me-2"></i>
                Video Touch Frame Extractor
            </span>
            <div>
                <a href="/annotator" class="btn btn-success btn-sm me-2">
                    <i class="fas fa-edit me-1"></i> Annotator
                </a>
                <button class="btn btn-light btn-sm" id="clearAllBtn">
                    <i class="fas fa-trash me-1"></i> Clear All
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Select Video</h5>
                        <button class="btn btn-light btn-sm" id="refreshBtn" title="Refresh video list">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="videoSelect" class="form-label">Available Videos</label>
                            <select class="form-select" id="videoSelect">
                                <option value="">Loading videos...</option>
                            </select>
                            <small class="text-muted">Videos from data folder, CSVs from csv folder</small>
                        </div>

                        <div class="video-info mt-3 d-none" id="videoInfoCard">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title mb-2">Video Information</h6>
                                    <div class="row text-small">
                                        <div class="col-6"><strong>Duration:</strong> <span id="videoDuration">-</span></div>
                                        <div class="col-6"><strong>FPS:</strong> <span id="videoFPS">-</span></div>
                                        <div class="col-6"><strong>Resolution:</strong> <span id="videoResolution">-</span></div>
                                        <div class="col-6"><strong>Size:</strong> <span id="videoSize">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="csv-status mt-3 d-none" id="csvStatus">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-csv me-2"></i>
                                <span id="csvStatusText">-</span>
                                <i class="status-icon ms-auto" id="csvStatusIcon"></i>
                            </div>
                            <small class="text-muted" id="csvStatusDetail">-</small>
                        </div>

                        <div class="extraction-mode mb-3 d-none" id="extractionMode">
                            <label class="form-label">Extraction Mode</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="extractionMode" id="touchMode" value="touch" checked>
                                <label class="btn btn-outline-primary" for="touchMode">Touch Frames Only</label>
                                <input type="radio" class="btn-check" name="extractionMode" id="timelineMode" value="timeline">
                                <label class="btn btn-outline-primary" for="timelineMode">Full Timeline</label>
                            </div>
                            <small class="text-muted">Touch mode extracts only frames with touch events. Timeline mode shows frames at selected FPS rate.</small>
                        </div>

                        <div class="extraction-fps mb-3 d-none" id="extractionFPS">
                            <label class="form-label">Timeline Frame Rate</label>
                            <select class="form-select form-select-sm" id="fpsSelector">
                                <option value="1">1 FPS (~62 frames)</option>
                                <option value="2">2 FPS (~124 frames)</option>
                                <option value="5" selected>5 FPS (~310 frames)</option>
                                <option value="10">10 FPS (~619 frames)</option>
                                <option value="15">15 FPS (~929 frames)</option>
                                <option value="30">30 FPS (all frames)</option>
                            </select>
                            <small class="text-muted">Higher FPS = more frames extracted. Original video is ~30 FPS.</small>
                        </div>

                        <button class="btn btn-primary w-100 mt-3" id="extractBtn" disabled>
                            <i class="fas fa-cogs me-2"></i>Extract Frames
                        </button>

                        <div class="progress mt-3 d-none" id="progressContainer">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar"></div>
                        </div>

                        <div class="alert alert-info mt-3 d-none" id="statusMessage"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            Frame Viewer
                            <span class="badge bg-light text-dark ms-2" id="frameCount">0</span>
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-info btn-sm" id="editModeBtn" disabled title="Edit touch annotations">
                                <i class="fas fa-edit me-1"></i> Edit Mode
                            </button>
                            <button class="btn btn-warning btn-sm d-none" id="prevTouchBtn" disabled title="Previous touch event">
                                <i class="fas fa-step-backward me-1"></i> Prev Touch
                            </button>
                            <button class="btn btn-warning btn-sm d-none" id="nextTouchBtn" disabled title="Next touch event">
                                <i class="fas fa-step-forward me-1"></i> Next Touch
                            </button>
                            <button class="btn btn-success btn-sm" id="saveFramesBtn" disabled title="Save frames for review">
                                <i class="fas fa-save me-1"></i> Save for Review
                            </button>
                            <button class="btn btn-light btn-sm" id="downloadCurrentBtn" disabled title="Download Current Frame">
                                <i class="fas fa-download me-1"></i> Current
                            </button>
                            <button class="btn btn-light btn-sm" id="downloadAllBtn" disabled title="Download All Frames">
                                <i class="fas fa-download me-1"></i> All
                            </button>
                            <button class="btn btn-light btn-sm" id="fullscreenBtn" disabled title="Fullscreen (F)">
                                <i class="fas fa-expand me-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Main Image Viewer -->
                        <div id="imageViewer" class="image-viewer">
                            <div class="viewer-empty d-flex align-items-center justify-content-center">
                                <div class="text-center text-muted">
                                    <i class="fas fa-inbox fa-5x mb-3"></i>
                                    <p>No frames extracted yet</p>
                                    <small>Select a video to get started</small>
                                </div>
                            </div>
                            
                            <!-- Main image display (hidden initially) -->
                            <div class="viewer-content d-none">
                                <div class="main-image-container">
                                    <img id="mainImage" src="" alt="Current frame" class="main-image">
                                    
                                    <!-- Navigation arrows -->
                                    <button class="nav-arrow nav-prev" id="prevBtn" title="Previous frame (←)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="nav-arrow nav-next" id="nextBtn" title="Next frame (→)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    
                                    <!-- Frame info overlay -->
                                    <div class="frame-info-overlay">
                                        <div class="frame-counter">
                                            <span id="currentFrameIndex">1</span> of <span id="totalFrames">1</span>
                                        </div>
                                        <div class="frame-details">
                                            <div class="frame-number">Frame #<span id="frameNumber">1</span></div>
                                            <div class="frame-time"><i class="fas fa-clock me-1"></i><span id="frameTime">0:00.000</span></div>
                                            <div class="frame-bodypart"><i class="fas fa-user me-1"></i><span id="frameBodyPart">-</span></div>
                                            <div class="save-status" id="saveStatus">
                                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                                <span>Unsaved</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Thumbnail strip at bottom -->
                                <div class="thumbnail-strip">
                                    <div class="thumbnail-container" id="thumbnailContainer">
                                        <!-- Thumbnails will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Video Player Section -->
                        <div class="video-player-section d-none" id="videoPlayerSection">
                            <div class="card-header bg-info text-white py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-play-circle me-1"></i> <strong>Video Playback</strong></span>
                                    <div>
                                        <button class="btn btn-light btn-sm" id="toggleVideoBtn" title="Show/Hide Video">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-light btn-sm" id="playAroundBtn" title="Play around current time">
                                            <i class="fas fa-search-plus"></i> Analyze
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="video-container d-none" id="videoContainer">
                                <video id="videoPlayer" controls preload="metadata" style="width: 100%; max-height: 500px; height: 400px;">
                                    Your browser does not support video playback.
                                </video>
                                
                                <!-- Video Controls -->
                                <div class="video-controls mt-2">
                                    <!-- Row 1: Playback & Status -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-3">
                                            <label class="form-label small">Playback Speed</label>
                                            <select class="form-select form-select-sm" id="playbackSpeed">
                                                <option value="0.25">0.25x (Slow)</option>
                                                <option value="0.5">0.5x</option>
                                                <option value="1" selected>1x (Normal)</option>
                                                <option value="1.5">1.5x</option>
                                                <option value="2">2x (Fast)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Loop Mode</label>
                                            <div class="form-check mt-1">
                                                <input class="form-check-input" type="checkbox" id="loopMode">
                                                <label class="form-check-label small" for="loopMode">
                                                    Loop ±2 seconds
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Current Position</label>
                                            <div class="bg-light p-1 rounded text-center small" id="currentVideoTime">
                                                0:00.0
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Current Frame</label>
                                            <div class="bg-info text-white p-1 rounded text-center small" id="currentVideoFrame">
                                                Frame: -
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Row 2: Navigation Controls -->
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label small">Jump to Time</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="seekTimeInput" 
                                                       placeholder="seconds" step="0.1" min="0">
                                                <button class="btn btn-outline-primary" id="seekBtn" title="Jump to time">
                                                    <i class="fas fa-clock"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Jump to Frame</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="seekFrameInput" 
                                                       placeholder="frame #" step="1" min="1">
                                                <button class="btn btn-outline-success" id="seekFrameBtn" title="Jump to frame">
                                                    <i class="fas fa-image"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Touch Navigation</label>
                                            <div class="btn-group btn-group-sm w-100">
                                                <button class="btn btn-outline-warning" id="prevTouchVideoBtn" title="Previous touch">
                                                    <i class="fas fa-step-backward"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" id="nextTouchVideoBtn" title="Next touch">
                                                    <i class="fas fa-step-forward"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">Quick Actions</label>
                                            <div class="btn-group btn-group-sm w-100">
                                                <button class="btn btn-outline-info" id="syncVideoBtn" title="Sync to current frame">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" id="centerVideoBtn" title="Reset to center">
                                                    <i class="fas fa-crosshairs"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Keyboard shortcuts info -->
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Video Shortcuts:</strong> Space = Play/Pause, ← → = Seek ±5s, ↑ ↓ = Volume, F = Fullscreen<br>
                                        <strong>Navigation:</strong> Enter in input fields to jump, Touch buttons to jump between touches, Sync to match frame viewer
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Mode Controls -->
                        <div class="edit-controls d-none" id="editControls">
                            <div class="card-header bg-warning text-dark py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-edit me-1"></i> <strong>Edit Mode Active</strong></span>
                                    <span class="badge bg-secondary" id="changesCount">0 changes</span>
                                </div>
                            </div>
                            <div class="card-body py-2">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-success btn-sm w-100" id="markTouchBtn" disabled>
                                            <i class="fas fa-hand-paper me-1"></i> Mark as Touch
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm" id="bodyPartSelect">
                                            <option value="Right Foot">Right Foot</option>
                                            <option value="Left Foot">Left Foot</option>
                                            <option value="Head">Head</option>
                                            <option value="Chest">Chest</option>
                                            <option value="Right Hand">Right Hand</option>
                                            <option value="Left Hand">Left Hand</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-danger btn-sm w-100" id="removeTouchBtn" disabled>
                                            <i class="fas fa-times me-1"></i> Remove Touch
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-primary btn-sm w-100" id="saveChangesBtn" disabled>
                                            <i class="fas fa-save me-1"></i> Save CSV
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-secondary btn-sm w-100" id="discardChangesBtn">
                                            <i class="fas fa-undo me-1"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Instructions:</strong> Click any frame to select it, then use buttons above to mark/remove touches. Changes are highlighted and saved to CSV when you click "Save CSV".
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Filter controls (moved to a collapsible section) -->
                        <div class="filter-section d-none" id="filterSection">
                            <div class="card-header bg-light py-2">
                                <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" data-bs-target="#filterControls" aria-expanded="false">
                                    <i class="fas fa-filter me-1"></i> Filters & Sorting
                                </button>
                            </div>
                            <div class="collapse" id="filterControls">
                                <div class="card-body py-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="filterInput" placeholder="Filter by body part...">
                                        <select class="form-select" id="sortSelect">
                                            <option value="frame">Sort by Frame Number</option>
                                            <option value="time">Sort by Time</option>
                                            <option value="bodypart">Sort by Body Part</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="frameModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Frame Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <img id="modalImage" class="img-fluid" alt="Frame">
                        </div>
                        <div class="col-md-4">
                            <div class="frame-details">
                                <h6>Frame Information</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Frame Number:</strong></td>
                                        <td id="modalFrameNumber"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Time:</strong></td>
                                        <td id="modalTime"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Body Part:</strong></td>
                                        <td id="modalBodyPart"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Timestamp:</strong></td>
                                        <td id="modalTimestamp"></td>
                                    </tr>
                                </table>
                                <button class="btn btn-primary w-100 mt-3" id="downloadFrameBtn">
                                    <i class="fas fa-download me-2"></i>Download Frame
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>